#!/bin/bash

RUN_DIR="/tmp/dtwitch/"
TABBED_PID=$RUN_DIR"/tabbed.pid"
TABBED_XID=$RUN_DIR"/tabbed.xid"

STREAM_NAME=$1

if [[ $STREAM_NAME == "" ]]; then
    echo NOTHING?!+ 
    exit 42
else
    URL="https://www.twitch.tv/"$STREAM_NAME 
    CHAT_URL="https://www.twitch.tv/"$STREAM_NAME"/chat?popout="
fi

# Open stream
( livestreamer $URL ) || {
    ERROR=$?
    echo livestreamer failed
    exit $ERROR
}

# Open chat
if [ ! -d "$RUN_DIR" ]; then
    ( mkdir $RUN_DIR ) || { 
        echo "Can't create dir $RUN_DIR"
        exit 12
    }
fi

PID=$(cat $TABBED_PID 2>/dev/null)
XID=$(cat $TABBED_XID 2>/dev/null)

ps -p $PID 2>&1 | grep '[t]'abbed > /dev/null 2>&1
TABBED_FOUND=$?
if [[ $TABBED_FOUND != 0 ]] || [[ $XID == "" ]] ; then 
    echo "Create new tabbed"
    if [[ $TABBED_FOUND != 0 ]]; then
        echo 'tabbed not found'
    fi 
    if [[ $XID == "" ]]; then 
        echo "XID is empty, why?!+" 
    fi 
    
    tabbed -n "twitch chat" -c  > $TABBED_XID &
    PID=$!
    echo $PID > $TABBED_PID
    XID=""; 
    for ii in 1 2 3 4 5 6 7 8 9; do 
        XID=$(cat $TABBED_XID 2>/dev/null)
        if [[ $XID != "" ]]; then
            break
        fi 
        sleep .1s 
    done 
fi 

echo xid: $XID
echo pid: $PID
<<<<<<< HEAD
echo 'surf -e $XID -l "'$STREAM_NAME'" "'$CHAT_URL'" > /dev/null 2>&1 '
=======
echo 'surf -e $XID -l "$STREAM_NAME" $CHAT_URL > /dev/null 2>&1 '
>>>>>>> 26d32dba78d5bf4f95b22b75b6cbc6306ef62438
surf -e $XID -l "$STREAM_NAME" $CHAT_URL > /dev/null 2>&1 & 
CHAT_PID=$!
echo $CHAT_PID

# firefox --new-window "https://www.twitch.tv/"$STREAM_NAME"/chat?popout=" &
echo livestreamer $URL best
livestreamer $URL best
kill -s 15 $CHAT_PID

